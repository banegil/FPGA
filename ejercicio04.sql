/abolish
/multiline on
/type_casting on
/date_format YYYY-MM-DD
/display_answer off


CREATE TABLE DEPARTMENT
  (DEPTNO CHARACTER(3) PRIMARY KEY
  ,DEPTNAME VARCHAR(36) NOT NULL
  ,MGRNO CHARACTER(6)
  ,ADMRDEPT CHARACTER(3) NOT NULL
  ,LOCATION CHARACTER(16));

INSERT INTO DEPARTMENT(DEPTNO,DEPTNAME,MGRNO,ADMRDEPT) VALUES
  ('A00','SPIFFY COMPUTER SERVICE','000010','A00'),
  ('B01','PLANNING','000020','A00'),
  ('C01','INFORMATION CENTER','000030','A00'),
  ('D01','DEVELOPMENT CENTER',NULL,'A00'),
  ('D11','MANUFACTURING SYSTEMS','000060','D01'),
  ('D21','ADMINISTRATION SYSTEMS','000070','D01'),
  ('E01','SUPPORT SERVICES','000050','A00'),
  ('E11','OPERATIONS','000090','E01'),
  ('E21','SOFTWARE SUPPORT','000100','E01'),
  ('F22','BRANCH OFFICE F2',NULL,'E01'),
  ('G22','BRANCH OFFICE G2',NULL,'E01');


CREATE TABLE EMPLOYEE
  (EMPNO CHARACTER(6) PRIMARY KEY
  ,FIRSTNAME VARCHAR(12) NOT NULL
  ,MIDINIT CHARACTER(1)
  ,LASTNAME VARCHAR(15) NOT NULL
  ,WORKDEPT CHARACTER(3) REFERENCES DEPARTMENT(DEPTNO)
  ,PHONENO CHARACTER(4)
  ,HIREDATE DATE
  ,JOB CHARACTER(8)
  ,EDLEVEL SMALLINT NOT NULL
  ,SEX CHARACTER(1)
  ,BIRTHDATE DATE
  ,SALARY DECIMAL(9,2)
  ,BONUS DECIMAL(9,2)
  ,COMM DECIMAL(9,2));

INSERT INTO EMPLOYEE 
  (EMPNO,FIRSTNAME,MIDINIT,LASTNAME,WORKDEPT,JOB,PHONENO,HIREDATE,SEX,EDLEVEL,BIRTHDATE,SALARY,BONUS,COMM) VALUES
  ('000010','CHRISTINE','I','HAAS','A00','CLERK','3978','1995-01-01','F',18,'1973-08-24',152750.0,4220.0,19185.0),
  ('000020','MICHAEL','L','THOMPSON','B01','MANAGER','3476','2003-10-10','M',18,'1978-02-02',94250.0,3300.0,18502.0),
  ('000030','SALLY','A','KWAN','C01','ANALYST','4738','2005-04-05','F',20,'1971-05-11',98250.0,3060.0,10144.0),
  ('000050','JOHN','B','GEYER','E01','MANAGER','6789','1979-08-17','M',16,'1975-09-15',80175.0,3214.0,2292.0),
  ('000060','IRVING','F','STERN','D11','DESIGNER','6423','2003-09-14','M',16,'1975-07-07',72250.0,2580.0,6092.0),
  ('000070','EVA','D','PULASKI','D21','CLERK','7831','2005-09-30','F',16,'2003-05-26',96170.0,2893.0,17354.0),
  ('000090','EILEEN','W','HENDERSON','E11','FIELDREP','5498','2000-08-15','F',16,'1971-05-15',89750.0,2380.0,15432.0),
  ('000100','THEODORE','Q','SPENSER','E21','FIELDREP','0972','2000-06-19','M',14,'1980-12-18',86150.0,2092.0,14740.0),
  ('000110','VINCENZO','G','LUCCHESSI','A00','PRES','3490','1988-05-16','M',19,'1979-11-05',66500.0,3720.0,7606.0),
  ('000120','SEAN',null,'O''CONNELL','A00','SALESREP','2167','1993-12-05','M',14,'1972-10-18',49250.0,2340.0,6334.0),
  ('000130','DELORES','M','OUINTANA','C01','MANAGER','4578','2001-07-28','F',16,'1975-09-15',73800.0,1904.0,32.0),
  ('000140','HEATHER','A','NICHOLLS','C01','MANAGER','1793','2006-12-15','F',18,'1976-01-19',68420.0,2274.0,3855.0),
  ('000150','BRUCE',null,'ADAMSON','D11','MANAGER','4510','2002-02-12','M',16,'1977-05-17',55280.0,2022.0,7180.0),
  ('000160','ELIZABETH','R','PIANKA','D11','DESIGNER','3782','2006-10-11','F',17,'1980-04-12',62250.0,1780.0,8851.0),
  ('000170','MASATOSHI','J','YOSHIMURA','D11','DESIGNER','2890','1999-09-15','M',16,'1981-01-05',44680.0,1974.0,2416.0),
  ('000180','MARILYN','S','SCOUTTEN','D11','DESIGNER','1682','2003-07-07','F',17,'1979-02-21',51340.0,1707.0,7348.0),
  ('000190','JAMES','H','WALKER','D11','DESIGNER','2986','2004-07-26','M',16,'1982-06-25',50450.0,1636.0,2728.0),
  ('000200','DAVID',null,'BROWN','D11','DESIGNER','4501','2002-03-03','M',16,'1971-05-29',57740.0,2217.0,6820.0),
  ('000210','WILLIAM','T','JONES','D11','DESIGNER','0942','1998-04-11','M',17,'2003-02-23',68270.0,1462.0,1748.0),
  ('000220','JENNIFER','K','LUTZ','D11','DESIGNER','0672','1998-08-29','F',18,'1978-03-19',49840.0,2387.0,9083.0),
  ('000230','JAMES','J','JEFFERSON','D21','CLERK','2094','1996-11-21','M',14,'1980-05-30',42180.0,1774.0,5518.0),
  ('000240','SALVATORE','M','MARINO','D21','CLERK','3780','2004-12-05','M',17,'2002-03-31',48760.0,2301.0,5899.0),
  ('000250','DANIEL','S','SMITH','D21','CLERK','0961','1999-10-30','M',15,'1979-11-12',49180.0,1534.0,8130.0),
  ('000260','SYBIL','P','JOHNSON','D21','MANAGER','8953','2005-09-11','F',16,'1976-10-05',47250.0,1380.0,8982.0),
  ('000270','MARIA','L','PEREZ','D21','CLERK','9001','2006-09-30','F',15,'2003-05-26',37380.0,2190.0,1286.0),
  ('000280','ETHEL','R','SCHNEIDER','E11','OPERATOR','8997','1997-03-24','F',17,'1976-03-28',36250.0,2100.0,5871.0),
  ('000290','JOHN','R','PARKER','E11','MANAGER','4502','2006-05-30','M',12,'1985-07-09',35340.0,1227.0,67.0);

  
CREATE TABLE PROJECT 
  (PROJNO CHAR(6) PRIMARY KEY
  ,PROJNAME VARCHAR(24)
  ,DEPTNO CHAR(3) REFERENCES DEPARTMENT
  ,RESPEMP CHAR(6)
  ,PRSTAFF DECIMAL(5,2)
  ,PRSTDATE DATE
  ,PRENDATE DATE
  ,MAJPROJ CHAR(6));

INSERT INTO PROJECT VALUES
  ('AD3100','ADMIN SERVICES','D01','000010',6.5,date '2002-1-1',date '2003-2-1',null),
  ('AD3110','GENERAL ADMIN SYSTEMS','D21','000070',6,date '2002-1-1',date '2003-2-1','AD3100'),
  ('AD3111','PAYROLL PROGRAMMING','D21','000230',2,date '2002-1-1',date '2003-2-1','AD3110'),
  ('AD3112','PERSONNEL PROGRAMMING','D21','000250',1,date '2002-1-1',date '2003-2-1','AD3110'),
  ('AD3113','ACCOUNT PROGRAMMING','D21','000270',2,date '2002-1-1',date '2003-2-1','AD3110'),
  ('IF1000','QUERY SERVICES','C01','000030',2,date '2002-1-1',date '2003-2-1',null),
  ('IF2000','USER EDUCATION','C01','000030',1,date '2002-1-1',date '2003-2-1',null),
  ('MA2100','WELD LINE AUTOMATION','D01','000010',12,date '2002-1-1',date '2003-2-1',null),
  ('MA2110','W L PROGRAMMING','D11','000060',9,date '2002-1-1',date '2003-2-1','MA2100'),
  ('MA2111','W L PROGRAM DESIGN','D11','000220',2,date '2002-1-1',date '1982-12-1','MA2110'),
  ('MA2112','W L ROBOT DESIGN','D11','000150',3,date '2002-1-1',date '1982-12-1','MA2110'),
  ('MA2113','W L PROD CONT PROGS','D11','000160',3,date '2002-2-15',date '1982-12-1','MA2110'),
  ('OP1000','OPERATION SUPPORT','E01','000050',6,date '2002-1-1',date '2003-2-1',null),
  ('OP1010','OPERATION','E11','000090',5,date '2002-1-1',date '2003-2-1','OP1000'),
  ('OP2000','GEN SYSTEMS SERVICES','E01','000050',5,date '2002-1-1',date '2003-2-1',null),
  ('OP2010','SYSTEMS SUPPORT','E21','000100',4,date '2002-1-1',date '2003-2-1','OP2000'),
  ('OP2011','SCP SYSTEMS SUPPORT','E21','000320',1,date '2002-1-1',date '2003-2-1','OP2010'),
  ('OP2012','APPLICATIONS SUPPORT','E21','000330',1,date '2002-1-1',date '2003-2-1','OP2010'),
  ('OP2013','DB/DC SUPPORT','E21','000340',1,date '2002-1-1',date '2003-2-1','OP2010'),
  ('PL2100','WELD LINE PLANNING','B01','000020',1,date '2002-1-1',date '2002-9-15','MA2100');

-- P. 83
SELECT PROJNO, DEPTNAME, MGRNO, LASTNAME 
FROM PROJECT JOIN DEPARTMENT ON PROJECT.DEPTNO = DEPARTMENT.DEPTNO 
             JOIN EMPLOYEE   ON DEPARTMENT.MGRNO = EMPLOYEE.EMPNO 
WHERE DEPARTMENT.DEPTNO = 'D21'
ORDER BY PROJNO;

SELECT PROJNO, DEPTNAME, MGRNO, LASTNAME 
FROM PROJECT, DEPARTMENT, EMPLOYEE
WHERE PROJECT.DEPTNO = DEPARTMENT.DEPTNO AND
      DEPARTMENT.MGRNO = EMPLOYEE.EMPNO AND 
      DEPARTMENT.DEPTNO = 'D21'
ORDER BY PROJNO;

-- P. 84
SELECT PROJNO, DEPTNAME, MGRNO, LASTNAME 
FROM PROJECT P JOIN DEPARTMENT D ON P.DEPTNO = D.DEPTNO 
               JOIN EMPLOYEE E   ON D.MGRNO = E.EMPNO 
WHERE D.DEPTNO = 'D21'
ORDER BY PROJNO;

SELECT P.PROJNO, D.DEPTNAME, D.MGRNO, E.LASTNAME 
FROM PROJECT P JOIN DEPARTMENT D ON P.DEPTNO = D.DEPTNO 
               JOIN EMPLOYEE E   ON D.MGRNO = E.EMPNO 
WHERE D.DEPTNO = 'D21'
ORDER BY P.PROJNO;

SELECT PROJNO, DEPTNAME, MGRNO, LASTNAME 
FROM PROJECT P JOIN DEPARTMENT D ON P.DEPTNO = D.DEPTNO 
               JOIN EMPLOYEE     ON MGRNO = EMPNO 
WHERE D.DEPTNO = 'D21'
ORDER BY PROJNO;

-- P. 85
SELECT PROJNO, DEPTNAME, MGRNO, LASTNAME 
FROM PROJECT NATURAL JOIN DEPARTMENT
             JOIN EMPLOYEE ON MGRNO = EMPNO 
WHERE DEPTNO = 'D21'
ORDER BY PROJNO;

SELECT * FROM PROJECT NATURAL JOIN DEPARTMENT JOIN EMPLOYEE ON MGRNO = EMPNO;

-- P. 88
SELECT E.EMPNO, E.LASTNAME, E.BIRTHDATE, M.BIRTHDATE, M.EMPNO
FROM EMPLOYEE E JOIN DEPARTMENT D ON E.WORKDEPT = D.DEPTNO
                JOIN EMPLOYEE   M ON D.MGRNO    = M.EMPNO
WHERE E.BIRTHDATE < M.BIRTHDATE;

-- P. 89
CREATE TABLE EMP(DNI STRING PRIMARY KEY, NOM STRING);

CREATE TABLE HIJOS(DNI STRING REFERENCES EMP, NOMH STRING, PRIMARY KEY(DNI, NOMH));

INSERT INTO EMP VALUES (1,'Pedro'),(2,'Eva');

INSERT INTO HIJOS VALUES (1,'Anita'),(1,'Pepín'), (2,'Carol');

SELECT NOM 
FROM EMP JOIN HIJOS AS H1 ON EMP.DNI = H1.DNI 
         JOIN HIJOS AS H2 ON EMP.DNI = H2.DNI 
WHERE H1.NOMH <> H2.NOMH;

-- P. 90
DROP TABLE HIJOS;

CREATE OR REPLACE TABLE EMP(DNI STRING PRIMARY KEY, NOM STRING, AP STRING, SUELDO INT, ND STRING, DNISUPERV STRING REFERENCES EMP(DNI));

INSERT INTO EMP(DNI,NOM,AP,DNISUPERV) VALUES (1,'n1','a1',null);

INSERT INTO EMP(DNI,NOM,AP,DNISUPERV) VALUES (2,'n2','a2',1);

SELECT E.AP, S.AP
FROM EMP E, EMP S
WHERE E.DNISUPERV = S.DNI;

-- P. 96
SELECT AVG(SALARY)
FROM EMPLOYEE;

SELECT EMPNO, LASTNAME
FROM EMPLOYEE
WHERE SALARY > 65329.81;

SELECT EMPNO, LASTNAME
FROM EMPLOYEE
WHERE SALARY > (SELECT AVG(SALARY) 
                FROM EMPLOYEE);

-- P. 97
SELECT EMPNO, LASTNAME, BONUS
FROM EMPLOYEE
WHERE BONUS = (SELECT MIN(BONUS) FROM EMPLOYEE);

-- P. 99
SELECT DEPTNO, DEPTNAME
FROM DEPARTMENT
WHERE DEPTNO NOT IN (SELECT DEPTNO
                     FROM PROJECT);

-- P. 102
SELECT LASTNAME, SALARY
FROM EMPLOYEE
WHERE SALARY > ALL (
  SELECT AVG(SALARY) 
  FROM EMPLOYEE
  GROUP BY WORKDEPT);

-- P. 104
SELECT LASTNAME, SALARY
FROM EMPLOYEE
WHERE WORKDEPT= 'E11' AND SALARY > ANY (
  SELECT AVG(SALARY)
  FROM EMPLOYEE
  GROUP BY WORKDEPT);

-- P. 106
SELECT WORKDEPT, AVG(SALARY) AS AVG_WORKDEPT
FROM EMPLOYEE
WHERE JOB <> 'MANAGER'
GROUP BY WORKDEPT
HAVING AVG(SALARY) > (
  SELECT AVG(SALARY) 
  FROM EMPLOYEE
  WHERE JOB <>'MANAGER')
ORDER BY AVG_WORKDEPT;

-- P. 111
SELECT EMPNO, LASTNAME, SALARY
FROM EMPLOYEE E
WHERE SALARY > (
    SELECT AVG (SALARY)
    FROM EMPLOYEE
    WHERE WORKDEPT = E.WORKDEPT);

-- P. 114
SELECT DEPTNO, DEPTNAME 
FROM DEPARTMENT D 
WHERE NOT EXISTS (
  SELECT *
  FROM EMPLOYEE
  WHERE WORKDEPT = D.DEPTNO);

-- P. 116
SELECT DEPTNAME, EMPNO, LASTNAME
FROM DEPARTMENT LEFT JOIN EMPLOYEE 
     ON WORKDEPT=DEPTNO 
ORDER BY DEPTNAME, LASTNAME;

-- P. 118
SELECT DEPTNAME, EMPNO, LASTNAME
FROM EMPLOYEE RIGHT JOIN DEPARTMENT 
     ON WORKDEPT=DEPTNO 
ORDER BY DEPTNAME, LASTNAME;

-- P.119
SELECT DEPTNAME, EMPNO, LASTNAME
FROM DEPARTMENT FULL JOIN EMPLOYEE 
     ON WORKDEPT=DEPTNO 
ORDER BY DEPTNAME, LASTNAME;

-- P.120
SELECT DEPTNO, DEPTNAME
FROM DEPARTMENT LEFT JOIN EMPLOYEE 
     ON WORKDEPT=DEPTNO 
WHERE LASTNAME IS NULL
ORDER BY DEPTNO;

